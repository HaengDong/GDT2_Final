<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Music Player Final (Merged)</title>
    
    <!-- 폰트 정의 -->
    <style>
        @font-face {
            font-family: 'OngleipKonkon';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2412-1@1.0/Ownglyph_corncorn-Rg.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Shouting';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2510-1@1.0/Callifont-Medium.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'ShillaBold';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2206-02@1.0/Shilla_CultureB-Bold.woff2') format('woff2');
            font-weight: 700;
            font-display: swap;
        }

        /* --- 1. 기본 설정 --- */
        :root {
            --album-size: 320px;
            --cursor-size: 50px;
        }

        body {
            margin: 0;
            padding: 0;
            background: transparent;
            color: #ffffff;
            font-family: 'ShillaBold', sans-serif;
            overflow: hidden;
            cursor: none; /* 기본 커서 숨김 */
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 배경 레이어 */
        .bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -10;
            background-size: cover;
            background-position: center;
            transition: opacity 1.5s ease, background 1.5s ease; /* background transition 추가 */
        }
        #bg-back { z-index: -10; }
        #bg-front { z-index: -9; }

        /* --- 2. 캔버스 (파티클 및 이펙트) --- */
        #trail-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9998; /* 배경 위, UI 아래 */
        }

        /* --- 3. 커스텀 커서 UI --- */
        #cursor {
            position: fixed; top: 0; left: 0;
            width: var(--cursor-size); height: var(--cursor-size);
            pointer-events: none; z-index: 10002;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
            transition: transform 0.2s ease;
        }
        .cursor-icon {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            fill: white;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .icon-clef { opacity: 1; transform: scale(1); }
        .icon-headset { opacity: 0; transform: scale(0.5); }
        
        body.mode-expanded .icon-clef { opacity: 0; transform: scale(0.5); }
        body.mode-expanded .icon-headset { opacity: 1; transform: scale(1); }

        /* --- 4. 보케(Bokeh) 효과 --- */
        .bokeh-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; overflow: hidden; pointer-events: none;
        }
        .bokeh {
            position: absolute;
            bottom: -150px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            filter: blur(8px);
            animation: rise linear infinite;
        }
        @keyframes rise {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            20% { opacity: 0.5; }
            80% { opacity: 0.5; }
            100% { transform: translateY(-120vh) scale(1.5); opacity: 0; }
        }

        /* --- 5. 플레이어 UI --- */
        .player-container {
            position: relative; z-index: 10;
            width: 100%; max-width: 800px;
            height: 700px;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 50px;
            perspective: 1200px;
            transition: all 0.5s ease;
        }

        .album-carousel {
            position: relative;
            width: 100%; height: 400px;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px;
            transform-style: preserve-3d; 
        }

        .card {
            position: absolute;
            width: var(--album-size); height: var(--album-size);
            background-color: rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            cursor: none;
        }

        /* 앨범 커버 이미지 */
        .album-art { 
            width: 100%; height: 100%; object-fit: cover; 
            pointer-events: none; transition: opacity 1s ease; opacity: 1;
        }

        .card.center { z-index: 10; transform: translateX(0) scale(1.1) rotateY(0deg); opacity: 1; filter: brightness(1); }
        .card.left { z-index: 5; transform: translateX(-280px) scale(0.8) rotateY(25deg); opacity: 0.7; filter: brightness(0.6) blur(2px); }
        .card.right { z-index: 5; transform: translateX(280px) scale(0.8) rotateY(-25deg); opacity: 0.7; filter: brightness(0.6) blur(2px); }
        
        /* 캐릭터 이미지 설정 */
        .character-img {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 130px; 
            height: auto;
            z-index: 20; 
            pointer-events: auto; /* 클릭 가능 */
            opacity: 0; /* 처음엔 안 보임 */
            transition: transform 0.8s ease, opacity 1s ease 0.5s; /* 나타날 때 딜레이(0.5s) 추가 */
        }
        
        /* 확장 모드(mode-expanded)일 때만 캐릭터 보임 */
        body.mode-expanded .card.center .character-img { 
            opacity: 1; 
        }

        /* 정보 영역 */
        .info-area {
            text-align: center; width: 100%;
            transition: opacity 0.5s ease, transform 0.5s ease;
            margin-top: 20px;
        }
        .song-title {
            font-size: 40px; margin-bottom: 20px;
            display: inline-block; white-space: nowrap;
            transition: 0.5s ease;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .font-type-0 { font-family: 'OngleipKonkon', sans-serif; font-size: 45px; }
        .font-type-1 { font-family: 'Shouting', serif; font-size: 48px; letter-spacing: 1px;}
        .font-type-2 { font-family: 'ShillaBold', serif; font-size: 42px; }

        .progress-bar {
            width: 300px; height: 4px;
            background: rgba(255,255,255,0.3);
            margin: 0 auto 30px auto;
            position: relative; border-radius: 2px;
        }
        .progress-fill {
            width: 0%; height: 100%; background: white;
            position: relative; transition: width 0.3s linear;
        }
        .progress-fill::after {
            content: ''; position: absolute; right: -6px; top: -4px;
            width: 12px; height: 12px; background: white; border-radius: 50%;
        }

        .controls {
            display: flex; justify-content: center; gap: 40px;
            align-items: center;
        }
        .btn {
            width: 40px; height: 40px; 
            cursor: none; transition: transform 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .btn:active { transform: scale(0.8); }
        .btn svg { 
            width: 100%; height: 100%; fill: currentColor; 
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
        }

        /* --- 나가기 버튼 --- */
        .close-btn {
            position: fixed; top: 40px; right: 40px;
            width: 40px; height: 40px;
            z-index: 10003; cursor: none;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease, transform 0.3s ease;
        }
        .close-btn svg { width: 100%; height: 100%; fill: white; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .close-btn:hover { transform: scale(1.1); }
        
        body.mode-expanded .close-btn { opacity: 1; pointer-events: auto; }

        /* --- 확장 모드 스타일 --- */
        body.mode-expanded .player-container {
            width: 100vw; height: 100vh; max-width: 100%; padding: 0; justify-content: center;
        }
        body.mode-expanded .album-carousel { height: 100vh; margin: 0; }
        body.mode-expanded .card.center {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            transform: none !important; 
            background: transparent; box-shadow: none; border-radius: 0; z-index: 50;
        }
        /* 확장 시 앨범아트는 사라짐 */
        body.mode-expanded .card.center .album-art { 
            opacity: 0; transition: opacity 1s ease 0.8s; 
        }
        body.mode-expanded .card.left, body.mode-expanded .card.right { opacity: 0; pointer-events: none; }
        body.mode-expanded .info-area { opacity: 0; transform: translateY(50px); pointer-events: none; }
        
        body.mode-expanded .character-img { 
            transform: translate(-50%, -50%) scale(2.0); /* 확장 시 캐릭터 확대 */
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }

    </style>
</head>
<body>

    <div id="bg-back" class="bg-layer"></div>
    <div id="bg-front" class="bg-layer"></div>

    <!-- 캔버스 (통합된 이펙트용) -->
    <canvas id="trail-canvas"></canvas>
    
    <div class="bokeh-container" id="bokeh-container"></div>

    <!-- 나가기 버튼 -->
    <div class="close-btn" onclick="toggleExpand()">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </div>

    <!-- 커서 -->
    <div id="cursor">
        <!-- 수정됨: 더 깔끔한 높은음자리표 SVG 경로 -->
        <svg class="cursor-icon icon-clef" fill="#000000" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 276.164 276.164">
            <g>
                <path d="M156.716,61.478c-4.111,6.276-8.881,11.511-14.212,15.609l-8.728,6.962c-13.339,11.855-22.937,21.433-28.542,28.464 c-10.209,12.788-15.806,25.779-16.65,38.611c-0.942,14.473,3.187,28.21,12.275,40.84c9.636,13.458,21.8,20.754,36.164,21.69 c3.291,0.218,6.897,0.182,9.896-0.015l-1.121-10.104c-2.09,0.192-4.306,0.223-6.628,0.068c-9.437-0.617-17.864-4.511-25.064-11.573 c-7.524-7.333-10.895-15.415-10.287-24.7c1.149-17.59,12.562-35.004,33.925-51.792l9.543-7.599 c8.394-7.174,15.192-16.191,20.216-26.825c4.971-10.556,7.886-21.983,8.673-33.96c0.466-7.037-0.513-15.775-2.874-25.965 c-3.241-13.839-7.854-20.765-14.136-21.179c-2.232-0.138-4.676,0.986-7.658,3.617c-7.252,6.548-12.523,14.481-15.683,23.542 c-2.438,6.926-4.057,16.189-4.805,27.529c-0.313,4.72,0.313,13.438,1.805,23.962l8.844-8.192c-0.028-1.183,0.005-2.413,0.096-3.703 c0.466-7.221,2.289-15.062,5.394-23.293c3.956-10.296,7.689-13.409,10.133-14.204c0.668-0.218,1.32-0.298,2.015-0.254 c3.185,0.212,6.358,1.559,5.815,9.979C164.664,46.132,161.831,53.693,156.716,61.478z"></path>
                <path d="M164.55,209.161c5.728-2.568,10.621-6.478,14.576-11.651c5.055-6.561,7.897-14.316,8.467-23.047 c0.72-10.719-1.854-20.438-7.617-28.895c-6.322-9.264-14.98-14.317-25.745-15.026c-1.232-0.081-2.543-0.075-3.895,0.025 l-2.304-17.191l-9.668,7.112l1.483,12.194c-5.789,2.393-10.827,6.17-15.017,11.255c-4.823,5.924-7.508,12.443-7.964,19.382 c-0.466,7.208,1.142,13.81,4.782,19.583c1.895,3.081,4.507,5.82,7.498,8.058c4.906,3.65,10.563,3.376,11.459,1.393 c0.906-1.983-2.455-5.095-5.09-9.248c-1.502-2.351-2.242-5.173-2.242-8.497c0-7.053,4.256-13.116,10.317-15.799l5.673,44.211 l1.325,10.258c0.864,4.873,1.719,9.725,2.537,14.52c1,6.488,1.352,12.112,1.041,16.715c-0.419,6.375-2.408,11.584-5.919,15.493 c-2.234,2.485-4.844,4.055-7.795,4.925c3.961-3.962,6.414-9.43,6.414-15.478c0-12.075-9.792-21.872-21.87-21.872 c-3.353,0-6.491,0.812-9.329,2.159c-0.36,0.155-0.699,0.388-1.054,0.574c-0.779,0.425-1.559,0.85-2.286,1.362 c-0.249,0.187-0.487,0.403-0.732,0.605c-4.888,3.816-8.091,9.616-8.375,16.229c0,0.01-0.011,0.021-0.011,0.031 c0,0.005,0,0.01,0,0.016c-0.013,0.311-0.09,0.59-0.09,0.896c0,0.259,0.067,0.492,0.078,0.74 c-0.011,7.084,2.933,13.179,8.839,18.118c5.584,4.666,12.277,7.28,19.892,7.777c4.327,0.28,8.505-0.217,12.407-1.485 c3.189-1.041,6.275-2.62,9.149-4.687c6.96-5.022,10.75-11.584,11.272-19.532c0.399-6.063,0.094-13.235-0.937-21.411l-2.838-18.429 l-7.156-52.899c7.984,1.532,14.027,8.543,14.027,16.968c0,5.986-1.937,15.431-5.551,20.376L164.55,209.161z"></path>
            </g>
        </svg>
        <svg class="cursor-icon icon-headset" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.00 512.00">
            <g><path d="M175.898,335.919c-3.812-25.66-27.679-43.357-53.33-39.546c-25.659,3.778-43.374,27.671-39.57,53.322 l18.12,122.236c3.804,25.65,27.671,43.365,53.33,39.554c25.651-3.795,43.357-27.662,39.562-53.33L175.898,335.919z"></path><path d="M389.438,296.373c-25.651-3.811-49.518,13.886-53.33,39.546l-18.121,122.236 c-3.786,25.667,13.911,49.535,39.571,53.33c25.65,3.812,49.518-13.903,53.33-39.554l18.12-122.236 C432.811,324.044,415.088,300.151,389.438,296.373z"></path><path d="M506.813,166.683l-11.106-21.231c-22.6-43.187-56.364-79.478-97.625-105.07 C356.864,14.799,307.997-0.009,256.003,0C204-0.009,155.132,14.799,113.914,40.382c-41.26,25.592-75.025,61.883-97.616,105.07 L5.192,166.683c-4.301,8.224-1.14,18.391,7.099,22.701l7.649,3.99c-7.952,24.315-12.322,50.262-12.322,77.247 c0.042,31.753,7.353,62.948,15.594,90.551c8.231,27.476,17.57,51.707,21.965,67.402l35.683-10.074 c-5.29-18.593-14.384-42.004-22.152-67.959c-7.767-25.87-14.055-53.98-14.004-79.919c0-20.791,3.034-40.838,8.621-59.803 l1.436,0.777c8.24,4.285,18.391,1.116,22.692-7.116l11.105-21.239c15.788-30.198,39.512-55.679,68.332-73.538 c28.828-17.859,62.567-28.136,99.112-28.144c36.536,0.008,70.284,10.286,99.112,28.144c28.813,17.858,52.536,43.34,68.324,73.538 l11.106,21.239c4.302,8.231,14.461,11.4,22.693,7.116l1.437-0.777c5.586,18.965,8.628,39.012,8.628,59.803 c0.042,25.938-6.237,54.049-14.012,79.919c-7.759,25.955-16.861,49.366-22.152,67.959l35.683,10.074 c4.395-15.695,13.734-39.926,21.966-67.402c8.24-27.602,15.559-58.798,15.592-90.551c0-26.986-4.37-52.932-12.322-77.247 l7.649-3.99C507.945,185.074,511.107,174.907,506.813,166.683z"></path></g>
        </svg>
    </div>

    <!-- UI 컨테이너 -->
    <div class="player-container">
        <div class="album-carousel" id="album-carousel">
            <!-- Cards generated by JS -->
        </div>

        <div class="info-area">
            <div class="song-title" id="song-title">TITLE</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="controls">
                <div class="btn" onclick="prevSong(event)"><svg viewBox="0 0 32 32"><g><path d="M14.297,3.736C14.669,3.332,15,3.45,15,4v24c0,0.55-0.331,0.668-0.703,0.264L3.69,16.736 c-0.372-0.405-0.365-1.068,0.007-1.473L14.297,3.736z"></path><path d="M14.706,29.504c-0.286,0-0.717-0.098-1.146-0.563L2.954,17.414c-0.727-0.791-0.724-2.032,0.006-2.827l10.6-11.527 c0.428-0.466,0.859-0.563,1.146-0.563C15.329,2.496,16,2.967,16,4v24C16,29.033,15.329,29.504,14.706,29.504z M14,5.538 L4.433,15.94c-0.025,0.027-0.023,0.102-0.006,0.119L14,26.463V5.538z"></path></g><g><path d="M27.136,3.736C27.508,3.332,28,3.45,28,4v24c0,0.55-0.492,0.668-0.864,0.264L16.449,16.736 c-0.372-0.405-0.325-1.068,0.047-1.473L27.136,3.736z"></path><path d="M27.602,29.504c-0.441,0-0.868-0.2-1.202-0.563L15.715,17.416c-0.718-0.781-0.697-2.022,0.044-2.829L26.401,3.058 c0.333-0.362,0.76-0.562,1.201-0.562C28.399,2.496,29,3.143,29,4v24C29,28.857,28.399,29.504,27.602,29.504z M27,5.358 l-9.77,10.584c-0.036,0.04-0.044,0.109-0.036,0.132L27,26.646V5.358z"></path></g></svg></div>
                <div class="btn" onclick="togglePlay(event)" id="play-btn"><svg viewBox="0 0 32 32"><g id="icon-play" style="display: block;"><path d="M4.993,2.496C4.516,2.223,4,2.45,4,3v26c0,0.55,0.516,0.777,0.993,0.504l22.826-13.008 c0.478-0.273,0.446-0.719-0.031-0.992L4.993,2.496z"></path></g><g id="icon-pause" style="display: none;"><path d="M6,4C5.45,4,5,4.45,5,5v22c0,0.55,0.45,1,1,1h3c0.55,0,1-0.45,1-1V5c0-0.55-0.45-1-1-1H6z"></path><path d="M23,4c-0.55,0-1,0.45-1,1v22c0,0.55,0.45,1,1,1h3c0.55,0,1-0.45,1-1V5c0-0.55-0.45-1-1-1H23z"></path></g></svg></div>
                <div class="btn" onclick="nextSong(event)"><svg viewBox="0 0 32 32"><g><path d="M4.561,3.728C4.184,3.328,4,3.45,4,4v24c0,0.55,0.184,0.672,0.561,0.272l10.816-11.544 c0.377-0.4,0.408-1.056,0.031-1.456L4.561,3.728z"></path><path d="M4.202,29.507L4.202,29.507C4.079,29.507,3,29.465,3,28V4c0-1.465,1.079-1.507,1.202-1.507 c0.568,0,0.958,0.414,1.087,0.55l10.848,11.545c0.725,0.77,0.711,2.038-0.031,2.826L5.29,28.956 C5.16,29.094,4.771,29.507,4.202,29.507z M5.004,5.66L5,26.337l9.674-10.389L5.004,5.66z"></path></g><g><path d="M17.561,3.728C17.184,3.328,17,3.45,17,4v24c0,0.55,0.184,0.672,0.561,0.272l10.816-11.544 c0.377-0.4,0.408-1.056,0.031-1.456L17.561,3.728z"></path><path d="M17.202,29.507L17.202,29.507C17.079,29.507,16,29.465,16,28V4c0-1.465,1.079-1.507,1.202-1.507 c0.568,0,0.958,0.414,1.087,0.55l10.848,11.545c0.725,0.77,0.711,2.038-0.031,2.826L18.29,28.956 C18.16,29.094,17.771,29.507,17.202,29.507z M18.004,5.66L18,26.337l9.674-10.389L18.004,5.66z"></path></g></svg></div>
            </div>
        </div>
    </div>

    <script>
        const themes = [
            { bg: "linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)", text: "#ffffff" },
            { bg: "linear-gradient(135deg, #111111 0%, #2e8b57 100%)", text: "#ffffff" },
            { bg: "linear-gradient(to top, #c2b280 0%, #e6d8b8 100%)", text: "#3e2723" }
        ];

        const songs = [
            { title: "음악 듣는게 좋아", img: "Image/music_1.png" }, 
            { title: "사람 많은 곳이 싫어", img: "Image/music_2.png" },
            { title: "검도가 싫어!!!", img: "Image/music_3.png" }
        ];

        let currentIndex = 0;
        let isExpanded = false;
        let isPlaying = false; 
        let cardElements = []; 

        // 애니메이션 관련 변수
        let particles = [];
        let darkCircles = [];
        let musicLines = [];
        let explosionEnabled = false;
        let characterAnimating = false;

        const carousel = document.getElementById('album-carousel');

        function initCarousel() {
            songs.forEach((song, i) => {
                const card = document.createElement('div');
                card.classList.add('card');
                
                const img = document.createElement('img');
                img.classList.add('album-art');
                img.src = song.img;
                img.onerror = function() { this.src = 'https://via.placeholder.com/300'; };
                card.appendChild(img);

                // 캐릭터 이미지
                const charImg = document.createElement('img');
                charImg.classList.add('character-img');
                charImg.src = 'Image/char_static.png'; // 기본 상태 (정지)
                charImg.onclick = (e) => playCharacterAnim(e);
                card.appendChild(charImg);

                card.onclick = (e) => {
                    if(isExpanded) return; 
                    
                    if (card.classList.contains('left')) prevSong(e);
                    else if (card.classList.contains('right')) nextSong(e);
                    else {
                        if (!isPlaying) togglePlay(e);
                        else toggleExpand();
                    }
                };

                carousel.appendChild(card);
                cardElements.push(card);
            });

            const front = document.getElementById('bg-front');
            const back = document.getElementById('bg-back');
            front.style.background = themes[0].bg;
            back.style.background = themes[0].bg;

            updateCarousel(); 
            createBokeh();
        }

        function updateCarousel() {
            const total = songs.length;
            const titleEl = document.getElementById('song-title');
            
            const back = document.getElementById('bg-back');
            const front = document.getElementById('bg-front');
            const newBg = themes[currentIndex].bg;
            
            // 확장 모드가 아닐 때만 그라디언트 테마 적용 (확장 시에는 이미지 배경 유지)
            if (!isExpanded) {
                back.style.background = newBg;
                front.style.opacity = 0;

                setTimeout(() => {
                    front.style.background = newBg;
                    front.style.transition = 'none';
                    front.style.opacity = 1;
                    setTimeout(() => {
                        front.style.transition = 'opacity 1.5s ease';
                    }, 50);
                }, 1500);
            }

            document.body.style.color = themes[currentIndex].text;
            
            titleEl.textContent = songs[currentIndex].title;
            titleEl.className = 'song-title font-type-' + currentIndex;

            cardElements.forEach((card, i) => {
                card.classList.remove('center', 'left', 'right');
                
                if (i === currentIndex) {
                    card.classList.add('center');
                } else if (i === (currentIndex - 1 + total) % total) {
                    card.classList.add('left');
                } else if (i === (currentIndex + 1) % total) {
                    card.classList.add('right');
                } else {
                    card.style.opacity = 0;
                }
            });
            
            const progress = document.getElementById('progress-fill');
            progress.style.transition = 'none';
            progress.style.width = '0%';
            setTimeout(() => { 
                progress.style.transition = 'width 0.3s linear';
                progress.style.width = '10%'; 
            }, 50);
        }

        function nextSong(e) {
            if(e) e.stopPropagation();
            currentIndex = (currentIndex + 1) % songs.length;
            updateCarousel();
        }

        function prevSong(e) {
            if(e) e.stopPropagation();
            currentIndex = (currentIndex - 1 + songs.length) % songs.length;
            updateCarousel();
        }

        function togglePlay(e) {
            if(e) e.stopPropagation();
            isPlaying = !isPlaying;

            const playIcon = document.getElementById('icon-play');
            const pauseIcon = document.getElementById('icon-pause');
            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                if (!isExpanded) toggleExpand();
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }

        function toggleExpand() {
            isExpanded = !isExpanded;
            document.body.classList.toggle('mode-expanded', isExpanded);
            
            const front = document.getElementById('bg-front');

            if (isExpanded) {
                // [수정됨] 확장 모드 진입 시: 배경을 현재 앨범 이미지로 변경 (어둡게 처리)
                const currentImg = songs[currentIndex].img;
                front.style.background = `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('${currentImg}') center/cover no-repeat`;
            } else {
                // [수정됨] 확장 모드 해제 시: 배경을 원래 테마(그라디언트)로 복구
                front.style.background = themes[currentIndex].bg;

                // [수정됨] 재생 상태 리셋: 나가면 정지 상태(재생 아이콘 보임)로 변경
                isPlaying = false;
                document.getElementById('icon-play').style.display = 'block';
                document.getElementById('icon-pause').style.display = 'none';

                // 캐릭터 및 효과 리셋
                const allChars = document.querySelectorAll('.character-img');
                allChars.forEach(c => {
                    c.src = 'Image/char_static.png'; // 원래대로
                });
                characterAnimating = false;
                explosionEnabled = false;
                clearDarkCircles();
                musicLines = [];
            }
        }

        // --- APNG 재생 + 곡별 인터렉션 효과 로직 ---
        function playCharacterAnim(event) {
            if (isExpanded) {
                event.stopPropagation();
                const charImg = event.target;
                
                // 이미 루프 중이면 클릭 무시
                if (charImg.src.includes('char_loop.png')) return;

                // [효과 트리거 추가] 곡 인덱스에 따라 다른 효과 발동
                if (currentIndex === 0) {
                    // 1번 곡: 빛과 오선지 효과
                    startMusicLinesEffect();
                } else if (currentIndex === 1) {
                    // 2번 곡: 어두운 원들이 밖으로 퍼짐
                    characterAnimating = true;
                    moveDarkCirclesOut();
                } else if (currentIndex === 2) {
                    // 3번 곡: 클릭 시 폭발 효과 활성화
                    enableExplosionEffect();
                }

                // 1. 점프 APNG
                charImg.src = 'Image/char_jump.png';

                // 2. 루프 APNG로 교체
                setTimeout(() => {
                    if (isExpanded && charImg.src.includes('char_jump.png')) {
                        charImg.src = 'Image/char_loop.png';
                    }
                }, 1500); 
            }
        }

        function createBokeh() {
            const container = document.getElementById('bokeh-container');
            for(let i=0; i<20; i++){
                const div = document.createElement('div');
                div.classList.add('bokeh');
                div.style.left = Math.random() * 100 + '%';
                div.style.width = Math.random() * 30 + 10 + 'px';
                div.style.height = div.style.width;
                div.style.animationDuration = Math.random() * 10 + 10 + 's';
                div.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(div);
            }
        }

        // ============================================
        // [Canvas Effect] 코드 2번의 효과 이식
        // ============================================
        const canvas = document.getElementById('trail-canvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 마우스 무브 이벤트 (커서 이동 + 파티클 생성)
        document.addEventListener('mousemove', (e) => {
            const cursor = document.getElementById('cursor');
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';

            // 확장 모드일 때만 파티클 생성
            if (isExpanded) {
                if (currentIndex === 0) {
                    // 1번 곡: 비누방울
                    if (Math.random() < 0.3) {
                        particles.push({
                            x: e.clientX, y: e.clientY,
                            vx: (Math.random() - 0.5) * 2,
                            vy: Math.random() * -3 - 1,
                            radius: Math.random() * 8 + 4,
                            life: 1, type: 'bubble'
                        });
                    }
                } else if (currentIndex === 1) {
                    // 2번 곡: 끈적이는 원
                    if (Math.random() < 0.4) {
                        particles.push({
                            x: e.clientX + (Math.random() - 0.5) * 20,
                            y: e.clientY + (Math.random() - 0.5) * 20,
                            radius: Math.random() * 15 + 10,
                            life: 1, fadeSpeed: Math.random() * 0.01 + 0.005,
                            type: 'sticky'
                        });
                    }
                }
                // 3번 곡은 클릭 시에만 반응
            }
        });

        // 클릭 이벤트 (3번 곡 폭발 효과)
        document.addEventListener('click', (e) => {
            if (isExpanded && currentIndex === 2 && explosionEnabled) {
                createExplosion(e.clientX, e.clientY);
            }
        });

        function createExplosion(x, y) {
            const count = 30;
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 / count) * i;
                const speed = Math.random() * 5 + 3;
                particles.push({
                    x: x, y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: Math.random() * 5 + 2,
                    life: 1,
                    color: `hsl(${Math.random() * 60 + 15}, 100%, 60%)`,
                    type: 'explosion'
                });
            }
        }

        // 메인 애니메이션 루프
        function animateCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 파티클 그리기
            particles = particles.filter(p => {
                if (p.type === 'bubble') {
                    p.x += p.vx; p.y += p.vy;
                    p.vy += 0.1; p.life -= 0.015;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${p.life * 0.6})`;
                    ctx.fill();
                    ctx.strokeStyle = `rgba(255, 255, 255, ${p.life * 0.8})`;
                    ctx.lineWidth = 2; ctx.stroke();
                    return p.life > 0;
                } else if (p.type === 'sticky') {
                    p.life -= p.fadeSpeed;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(80, 60, 100, ${p.life * 0.5})`;
                    ctx.fill();
                    return p.life > 0;
                } else if (p.type === 'explosion') {
                    p.x += p.vx; p.y += p.vy;
                    p.vx *= 0.95; p.vy *= 0.95; p.life -= 0.02;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color.replace(')', `, ${p.life})`).replace('hsl', 'hsla');
                    ctx.fill();
                    return p.life > 0;
                } else if (p.type === 'sparkle') {
                    p.life -= 0.02;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 200, ${p.life})`;
                    ctx.fill();
                    return p.life > 0;
                }
                return false;
            });

            // 2번 곡: 어두운 원 그리기
            if (currentIndex === 1 && isExpanded) {
                // 원 생성 로직이 최초 한 번 실행되지 않았으면 실행
                if (darkCircles.length === 0 && !characterAnimating) {
                   createDarkCircles();
                }

                darkCircles.forEach(circle => {
                    if (characterAnimating) {
                        const dx = circle.targetX - circle.x;
                        const dy = circle.targetY - circle.y;
                        circle.x += dx * 0.02;
                        circle.y += dy * 0.02;
                        circle.opacity -= 0.005;
                    }
                    if (circle.opacity > 0) {
                        ctx.beginPath();
                        ctx.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(40, 30, 50, ${circle.opacity})`;
                        ctx.fill();
                    }
                });
                darkCircles = darkCircles.filter(c => c.opacity > 0);
            }

            requestAnimationFrame(animateCanvas);
        }

        // 1번 곡 효과: 오선지 및 반짝임
        function startMusicLinesEffect() {
            // 오선 생성
            const lineCount = 5;
            for (let i = 0; i < lineCount; i++) {
                setTimeout(() => {
                    musicLines.push({ y: Math.random() * canvas.height, opacity: 1, width: canvas.width });
                }, i * 300);
            }
            
            // 오선 애니메이션 인터벌
            const lineInterval = setInterval(() => {
                if (!isExpanded || currentIndex !== 0) {
                    clearInterval(lineInterval);
                    musicLines = [];
                    return;
                }
                // 추가 오선
                if (Math.random() < 0.1) {
                    musicLines.push({ y: Math.random() * canvas.height, opacity: 1, width: canvas.width });
                }
                // 그리기
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                musicLines.forEach(line => {
                    line.opacity -= 0.01;
                    ctx.globalAlpha = line.opacity;
                    for (let i = 0; i < 5; i++) {
                        ctx.beginPath(); ctx.moveTo(0, line.y + i * 8); ctx.lineTo(line.width, line.y + i * 8); ctx.stroke();
                    }
                });
                ctx.globalAlpha = 1;
                musicLines = musicLines.filter(l => l.opacity > 0);
            }, 100);

            // 반짝임 인터벌
            const sparkleInterval = setInterval(() => {
                if (!isExpanded || currentIndex !== 0) {
                    clearInterval(sparkleInterval); return;
                }
                for (let i = 0; i < 3; i++) {
                    particles.push({
                        x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                        radius: Math.random() * 3 + 1, life: 1, type: 'sparkle'
                    });
                }
            }, 200);
        }

        // 2번 곡 효과: 어두운 원
        function createDarkCircles() {
            darkCircles = [];
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const angle = Math.atan2(y - canvas.height / 2, x - canvas.width / 2);
                darkCircles.push({
                    x: x, y: y,
                    targetX: x + Math.cos(angle) * 2000,
                    targetY: y + Math.sin(angle) * 2000,
                    radius: Math.random() * 30 + 20,
                    opacity: 0.7
                });
            }
        }
        function moveDarkCirclesOut() {
            if (darkCircles.length === 0) createDarkCircles();
        }
        function clearDarkCircles() { darkCircles = []; }
        function enableExplosionEffect() { explosionEnabled = true; }

        
        initCarousel();
        animateCanvas();

    </script>
</body>
</html>
